<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoEnergia</title>
    <!-- Enlace al archivo de estilos existente -->
    <link rel="stylesheet" href="styles.css">
    <!-- Enlace a Font Awesome para los iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
</head>

<body>
    <!-- Contenedor principal -->
    <div class="container">
        <!-- Barra lateral de navegación -->
        <div class="sidebar">
            <div class="logo-container">
                <img src="images/logo.png" alt="EcoEnergía" class="logo">
                <h2>EcoEnergía</h2>
            </div>
            <nav class="nav-menu">
                <ul>
                    <li class="nav-item active" data-section="inicio">
                        <a href="#"><i class="fas fa-home"></i> Inicio</a>
                    </li>
                    <li class="nav-item" data-section="login">
                        <a href="#"><i class="fas fa-sign-in-alt"></i> Ingresar</a>
                    </li>
                    <li class="nav-item" data-section="registro">
                        <a href="#"><i class="fas fa-user-plus"></i> Registrarse</a>
                    </li>
                    <li class="nav-item" data-section="ver-tareas" id="verTareasMenuItem" style="display: none;">
                        <a href="#"><i class="fas fa-tasks"></i> Ver Tareas</a>
                    </li>
                </ul>
            </nav>
            <div class="sidebar-footer">
                <span>© 2023 EcoEnergía</span>
            </div>
        </div>

        <!-- Contenido principal -->
        <div class="main-content">
            <!-- Contenedor del login -->
            <div id="loginContainer">
                <!-- Sección de inicio -->
                <section id="inicio" class="section active">
                    <div class="hero">
                        <div class="hero-overlay"></div>
                        <div class="hero-content">
                            <h1>Bienvenido a EcoEnergía</h1>
                            <p>Gestiona tus tareas de manera eficiente y sostenible.</p>
                            <a href="#" class="btn primary-btn" data-section="login">Iniciar sesión</a>
                        </div>
                    </div>
                </section>

                <!-- Sección de login -->
                <section id="login" class="section">
                    <form class="auth-form" id="loginForm">
                        <h2>Iniciar Sesión</h2>
                        <div class="form-group">
                            <label for="username">Usuario</label>
                            <input type="text" id="username" placeholder="Ingresa tu correo" required>
                        </div>
                        <div class="form-group">
                            <label for="password">Contraseña</label>
                            <input type="password" id="password" placeholder="Ingresa tu contraseña" required>
                        </div>
                        <button type="submit" class="btn primary-btn">Entrar</button>
                        <div id="loginError" class="error-message"></div>
                    </form>
                </section>

                <!-- Sección de registro -->
                <section id="registro" class="section">
                    <form class="auth-form" id="registerForm">
                        <h2>Registro</h2>
                        <div class="form-group">
                            <label for="nombre">Nombre</label>
                            <input type="text" id="nombre" placeholder="Ingresa tu nombre" required>
                        </div>
                        <div class="form-group">
                            <label for="apellido">Apellido</label>
                            <input type="text" id="apellido" placeholder="Ingresa tu apellido" required>
                        </div>
                        <div class="form-group">
                            <label for="usuario">Usuario</label>
                            <input type="text" id="usuario" placeholder="Ingresa tu usuario" required>
                        </div>
                        <div class="form-group">
                            <label for="correo">Correo Electrónico</label>
                            <input type="email" id="correo" placeholder="Ingresa tu correo" required>
                        </div>
                        <div class="form-group">
                            <label for="passwordRegister">Contraseña</label>
                            <input type="password" id="passwordRegister" placeholder="Crea una contraseña" required>
                        </div>
                        <button type="submit" class="btn primary-btn">Registrarse</button>
                        <div id="registerError" class="error-message"></div>
                    </form>
                </section>
            </div>

            <!-- Contenedor del dashboard -->
            <div id="dashboardContainer" style="display: none;">
                <div class="dashboard-header">
                    <h2 id="welcomeMessage">Bienvenido</h2>
                    <button id="logoutButton" class="btn secondary-btn">Cerrar Sesión</button>
                </div>

                <!-- Sección para ver tareas -->
                <section id="ver-tareas" class="section active">
                    <div class="tasks-header">
                        <h2>Tus Tareas</h2>
                        <button id="addTaskButton" class="btn primary-btn">Añadir Tarea</button>
                    </div>
                    <div class="task-container">
                        <table id="tasksTable">
                            <thead>
                                <tr>
                                    <th>Nombre</th>
                                    <th>Descripción</th>
                                    <th>Actividad</th>
                                    <th>Asignado a</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- Sección para crear/editar tarea -->
                <section id="crear-tarea" class="section" style="display: none;">
                    <h2 id="formTitle">Crear Nueva Tarea</h2>
                    <form class="task-form" id="taskForm">
                        <div class="form-group">
                            <label for="taskName">Nombre de la Tarea</label>
                            <input type="text" id="taskName" placeholder="Ingresa el nombre de la tarea" required>
                        </div>
                        <div class="form-group">
                            <label for="taskDescription">Descripción de la Tarea</label>
                            <textarea id="taskDescription" placeholder="Describe la tarea" required></textarea>
                        </div>
                        <div class="form-group">
                            <label for="activitySelect">Actividad</label>
                            <select id="activitySelect" required>
                                <!-- Opciones de actividades -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="userSelect">Asignar a</label>
                            <select id="userSelect" required>
                                <!-- Opciones de usuarios -->
                            </select>
                        </div>
                        <div class="form-buttons">
                            <button type="submit" class="btn primary-btn">Guardar Tarea</button>
                            <button type="button" id="cancelButton" class="btn secondary-btn">Cancelar</button>
                        </div>
                        <div id="taskError" class="error-message"></div>
                    </form>
                </section>
            </div>
        </div>
    </div>

    <!-- Script para manejar la navegación entre secciones -->
    <script>
        const menuItems = document.querySelectorAll('.sidebar ul li');
        const sections = document.querySelectorAll('.section');

        // Función para cambiar de sección
        function switchToSection(sectionId) {
            // Actualizar navegación lateral
            menuItems.forEach(i => {
                if (i.getAttribute('data-section') === sectionId) {
                    i.classList.add('active');
                } else {
                    i.classList.remove('active');
                }
            });
            // Mostrar la sección correspondiente
            sections.forEach(section => {
                if (section.id === sectionId) {
                    section.classList.add('active');
                } else {
                    section.classList.remove('active');
                }
            });
        }

        menuItems.forEach(item => {
            item.addEventListener('click', () => {
                const sectionToShow = item.getAttribute('data-section');
                switchToSection(sectionToShow);
            });
        });

        // Manejo de botones que cambian de sección
        const buttons = document.querySelectorAll('[data-section]');
        buttons.forEach(button => {
            button.addEventListener('click', (e) => {
                e.preventDefault();
                const sectionToShow = button.getAttribute('data-section');
                switchToSection(sectionToShow);
            });
        });
    </script>

    <!-- Tu código JavaScript -->
    <script>
        // URL base del backend
        const BASE_URL = 'http://localhost:3001/api';

        // Verificar si el usuario está autenticado
        let currentUser = null;

        function updateUI() {
            const loginContainer = document.getElementById('loginContainer');
            const dashboardContainer = document.getElementById('dashboardContainer');
            const verTareasMenuItem = document.getElementById('verTareasMenuItem');

            if (currentUser && currentUser.nombre) {
                loginContainer.style.display = 'none';
                dashboardContainer.style.display = 'block';
                document.getElementById('welcomeMessage').textContent = `Bienvenido, ${currentUser.nombre}`;
                // Mostrar el menú "Ver Tareas"
                verTareasMenuItem.style.display = 'block';
            } else {
                loginContainer.style.display = 'block';
                dashboardContainer.style.display = 'none';
                // Ocultar el menú "Ver Tareas"
                verTareasMenuItem.style.display = 'none';
            }
        }

        // Función para cambiar de sección desde cualquier parte del código
        function switchToSection(sectionId) {
            // Actualizar navegación lateral
            menuItems.forEach(i => {
                if (i.getAttribute('data-section') === sectionId) {
                    i.classList.add('active');
                } else {
                    i.classList.remove('active');
                }
            });
            // Mostrar la sección correspondiente
            sections.forEach(section => {
                if (section.id === sectionId) {
                    section.classList.add('active');
                } else {
                    section.classList.remove('active');
                }
            });
        }

        // Manejo del formulario de inicio de sesión
        if (document.getElementById('loginForm')) {
            const loginForm = document.getElementById('loginForm');
            const loginError = document.getElementById('loginError');

            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;

                try {
                    const response = await fetch(`${BASE_URL}/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ username, password })
                    });

                    if (response.ok) {
                        currentUser = await response.json();
                        updateUI();
                        await initializeDashboard();
                        switchToSection('ver-tareas'); // Redirigir a la vista de tareas
                    } else {
                        const errorText = await response.text();
                        loginError.textContent = errorText;
                        loginError.style.display = 'block';
                    }
                } catch (error) {
                    loginError.textContent = 'Error en el servidor';
                    loginError.style.display = 'block';
                }
            });
        }

        // Manejo del formulario de registro
        if (document.getElementById('registerForm')) {
            const registerForm = document.getElementById('registerForm');
            const registerError = document.getElementById('registerError');

            registerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const nombre = document.getElementById('nombre').value;
                const apellido = document.getElementById('apellido').value;
                const usuario = document.getElementById('usuario').value;
                const correo = document.getElementById('correo').value;
                const password = document.getElementById('passwordRegister').value;

                try {
                    const response = await fetch(`${BASE_URL}/register`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ nombre, apellido, usuario, correo, password })
                    });

                    if (response.ok) {
                        // Registro exitoso, redirigir al login
                        alert('Registro exitoso. Ahora puedes iniciar sesión.');
                        // Cambiar a la sección de login
                        switchToSection('login');
                    } else {
                        const errorText = await response.text();
                        registerError.textContent = errorText;
                        registerError.style.display = 'block';
                    }
                } catch (error) {
                    registerError.textContent = 'Error en el servidor';
                    registerError.style.display = 'block';
                }
            });
        }

        // Inicializar el dashboard
        async function initializeDashboard() {
            console.log(currentUser);

            await fetchTasks();
            await fetchActivities();
            await fetchUsers();
        }

        async function fetchTasks() {

            try {
                const response = await fetch(`${BASE_URL}/task`, {
                    method: 'GET',
                    credentials: 'include'
                });

                if (response.ok) {

                    renderTasks(await response.json());
                } else {
                    tasksTableBody.innerHTML = '<tr><td colspan="5">Error al cargar las tareas</td></tr>';
                }
            } catch (error) {
                tasksTableBody.innerHTML = '<tr><td colspan="5">Error en el servidor</td></tr>';
            }
        }


        async function fetchUsers() {
            try {
                const response = await fetch(`${BASE_URL}/usuario`, {
                    method: 'GET',
                    credentials: 'include'
                });

                if (response.ok) {
                    const users = await response.json();
                    populateUsers(users);
                } else {
                    userSelect.innerHTML = '<option value="">Error al cargar usuarios</option>';
                }
            } catch (error) {
                userSelect.innerHTML = '<option value="">Error en el servidor</option>';
            }
        }

        async function fetchActivities() {
            try {
                const response = await fetch(`${BASE_URL}/actividad`, {
                    method: 'GET',
                    credentials: 'include'
                });

                if (response.ok) {
                    const activities = await response.json();
                    populateActivities(activities);
                } else {
                    activitySelect.innerHTML = '<option value="">Error al cargar actividades</option>';
                }
            } catch (error) {
                activitySelect.innerHTML = '<option value="">Error en el servidor</option>';
            }
        }


        const tasksTableBody = document.querySelector('#tasksTable tbody');
        const taskFormContainer = document.getElementById('crear-tarea'); // Actualizado
        const taskForm = document.getElementById('taskForm');
        const taskError = document.getElementById('taskError');
        const logoutButton = document.getElementById('logoutButton');
        const addTaskButton = document.getElementById('addTaskButton');
        const cancelButton = document.getElementById('cancelButton');
        const activitySelect = document.getElementById('activitySelect');
        const userSelect = document.getElementById('userSelect');
        let isEditing = false;
        let editingTaskId = null;

        function populateActivities(activities) {
            activitySelect.innerHTML = '<option value="">Seleccione una actividad</option>';
            activities.forEach((activity) => {
                const option = document.createElement('option');
                option.value = activity._id;
                option.textContent = activity.nombre;
                activitySelect.appendChild(option);
            });
        }


        function populateUsers(users) {
            userSelect.innerHTML = '<option value="">Seleccione un usuario</option>';
            users.forEach((user) => {
                const option = document.createElement('option');
                option.value = user._id;
                option.textContent = `${user.nombre} ${user.apellido}`;
                userSelect.appendChild(option);
            });
        }

        // Renderizar tareas en la tabla
        function renderTasks(tasks) {
            console.log(tasks);
            
            tasksTableBody.innerHTML = ''; // Limpiar la tabla
            tasks.forEach((task) => {
                const row = document.createElement('tr');

                const nameCell = document.createElement('td');
                nameCell.textContent = task.nombre;
                row.appendChild(nameCell);

                const descCell = document.createElement('td');
                descCell.textContent = task.descripcion || '';
                row.appendChild(descCell);

                const activityCell = document.createElement('td');
                activityCell.textContent = task.actividad ? task.actividad.nombre : '';
                row.appendChild(activityCell);

                const userCell = document.createElement('td');
                userCell.textContent = task.empleado ? `${task.empleado.nombre} ${task.empleado.apellido}` : '';
                row.appendChild(userCell);

                const actionsCell = document.createElement('td');

                const editButton = document.createElement('button');
                editButton.classList.add('btn_edit');
                editButton.textContent = 'Editar';
                editButton.addEventListener('click', () => editTask(task));
                actionsCell.appendChild(editButton);

                const deleteButton = document.createElement('button');
                deleteButton.classList.add('btn_delete');
                deleteButton.textContent = 'Eliminar';
                deleteButton.addEventListener('click', () => deleteTask(task._id));
                actionsCell.appendChild(deleteButton);

                const completedCheckbox = document.createElement('input');
                completedCheckbox.type = 'checkbox';
                completedCheckbox.checked = task.completado;
                completedCheckbox.addEventListener('change', () => toggleTaskCompletion(task._id, completedCheckbox.checked));
                actionsCell.appendChild(completedCheckbox);

                row.appendChild(actionsCell);

                tasksTableBody.appendChild(row);
            });
        }

        addTaskButton.addEventListener('click', () => {
            isEditing = false;
            editingTaskId = null;
            taskForm.reset();
            document.getElementById('formTitle').textContent = 'Añadir Nueva Tarea';
            taskFormContainer.style.display = 'block';
            document.getElementById('ver-tareas').style.display = 'none';
        });

        cancelButton.addEventListener('click', () => {
            taskFormContainer.style.display = 'none';
            document.getElementById('ver-tareas').style.display = 'block';
            taskError.textContent = '';
        });

        taskForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const taskName = document.getElementById('taskName').value;
            const taskDescription = document.getElementById('taskDescription').value;
            const activityId = activitySelect.value;
            const userId = userSelect.value;

            const taskData = {
                nombre: taskName,
                descripcion: taskDescription,
                actividad: activityId,
                empleado: userId,
                administrador: currentUser._id
            };

            try {
                let response;
                if (isEditing) {
                    response = await fetch(`${BASE_URL}/task/${editingTaskId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify(taskData)
                    });
                } else {
                    response = await fetch(`${BASE_URL}/task`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify(taskData)
                    });
                }

                if (response.ok) {
                    await fetchTasks();
                    taskForm.reset();
                    // Ocultar el formulario de tarea
                    taskFormContainer.style.display = 'none';
                    document.getElementById('ver-tareas').style.display = 'block';
                    taskError.textContent = '';
                } else {
                    const errorText = await response.text();
                    taskError.textContent = errorText;
                }
            } catch (error) {
                taskError.textContent = 'Error en el servidor';
            }
        });

        function editTask(task) {
            isEditing = true;
            editingTaskId = task._id;
            document.getElementById('taskName').value = task.nombre;
            document.getElementById('taskDescription').value = task.descripcion || '';
            activitySelect.value = task.actividad ? task.actividad._id : '';
            userSelect.value = task.empleado ? task.empleado._id : '';
            document.getElementById('formTitle').textContent = 'Editar Tarea';
            taskFormContainer.style.display = 'block';
            document.getElementById('ver-tareas').style.display = 'none';
        }

        // Función para eliminar tarea
        async function deleteTask(id) {
            if (confirm('¿Estás seguro de que deseas eliminar esta tarea?')) {
                try {
                    const response = await fetch(`${BASE_URL}/tarea/${id}`, {
                        method: 'DELETE',
                        credentials: 'include'
                    });

                    if (response.ok) {
                        await fetchTasks();
                    } else {
                        alert('Error al eliminar la tarea');
                    }
                } catch (error) {
                    alert('Error en el servidor');
                }
            }
        }

        // Función para marcar tarea como completada
        async function toggleTaskCompletion(id, completed) {
            try {
                const response = await fetch(`${BASE_URL}/tarea/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ completado: completed })
                });

                if (response.ok) {
                    await fetchTasks();
                } else {
                    alert('Error al actualizar la tarea');
                }
            } catch (error) {
                alert('Error en el servidor');
            }
        }

        // Manejo del botón de cerrar sesión
        logoutButton.addEventListener('click', async () => {
            try {
                const response = await fetch(`${BASE_URL}/logout`, {
                    method: 'POST',
                    credentials: 'include'
                });

                if (response.ok) {
                    currentUser = null;
                    updateUI();
                    switchToSection('inicio'); // Redirigir a la sección de inicio
                } else {
                    alert('Error al cerrar sesión');
                }
            } catch (error) {
                alert('Error en el servidor');
            }
        });

        // Inicialización de la interfaz al cargar la página
        document.addEventListener('DOMContentLoaded', () => {
            updateUI();
        });
    </script>
</body>

</html>